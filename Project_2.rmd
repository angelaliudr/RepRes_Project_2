---
title: "Storm_Data_Analysis_Project_2"
author: "Angela Liu"
date: "September 17, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
require(grDevices)
```

# Storm Data Analysis to Identify the Most Damaging Disaster Types to Population Health and Economy 

## Synopsis 
Severe weathers are natural disaters that could adversely affect human beings by killing or injuring people and damaging their properties or crops. In this report, the National Climatic Data Center Storm Events data set is analyzed to identify the disaster types that result in the most severe damages. We use fatality rate, injury, property damage, and crop damage as the main metrics to assess the damage of each diaster type to people and to the economy. We found that tornado, heat, and flood are the top three disaster types incurring the most damage to people, based on the fatality and injury data. In comparison, flood, hurricane/typoon, and tornado are the top three disaster types causing the most property damage. Accurate forecast and emergency preparedness for these types of disasters, therefore, are of paramount importance in saving people's lives and minimizing property damage. 

## Data Processing
The storm data set is downloaded first from "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2" onto the local hard drive. Then the file is read in by R into a data frame for analysis. 

```{r cache=TRUE}
# download bz2 file to local folder
weblink <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
destfile <- "storm_data.csv.bz2"
success_code <- 0

# if file has not been downloaded, download it to local folder
if(!file.exists(destfile)){
  success_code <- download.file(weblink, destfile)
}

# if file has been successfully downloaded, read it into a data frame 
if (success_code == 0) {
  data <- read.csv(destfile, header=TRUE, sep=",", quote="\"")
}

# visually inspect the data frame structure and first a few rows 
str(data)
head(data)

```


## Results

### Events Most Harmful to Population Health

In the first analysis, we aim to find what disaster events are the most harmful to population health. We examine the storm data and focus on the fatality and injury counts. We first find all unique disaster event types by converting event types into all uppercase representation. Then for each diaster event type, we find the total count of the number of fatalities or injuries. We then sort the counts in descending order to find the disaster event types causing the most harm to human health. We sort first using the fatality counts and then using the injury counts.   

```{r}
# extract event type, fatality, and injury data to form a new data frame 
health_data <- cbind.data.frame("EVTYPE"=data$EVTYPE, "FATAL"=data$FATALITIES, "INJUR"=data$INJURIES)

# find unique (formatted to be uppercase) event types 
ev_types <- unique(toupper(health_data$EVTYPE))

# form a new data frame using the unique event types 
dam_count <- matrix(0, ncol=2, nrow=length(ev_types))

# for each event type, sum up the fatality and injury counts across multiple events 
for (index in 1:length(ev_types)) {
  evtype <- ev_types[index]
  dam_count[index, 1] <-  sum(health_data$FATAL[health_data$EVTYPE==evtype]) 
  dam_count[index, 2] <-  sum(health_data$INJUR[health_data$EVTYPE==evtype])  
}

# form a data frame to contain the event type and damage count data (both fatality and injury)
dam_data <- cbind.data.frame("EVTYPE"=ev_types, "FATCNT"=dam_count[, 1], "INJCNT"=dam_count[, 2])

# sort dam_data in descending order according to fatality first and then according to injuries 
dam_sorted <- dam_data[order(-dam_data$FATCNT, -dam_data$INJCNT), ]

# print out the first 20 event types with the most damage to health, i.e., 
#     with the highest fatality rate and injury counts 
head(dam_sorted, n=20)

# use the top 20 data for plotting 
top_dam_data <- dam_sorted[1:20, ]

# plot the sorted damage counts using a barplot for the top 20 diaster types
par(pin=c(4, 8), mai=c(3,1,0.5,1), mgp=c(3,0.5,0), xpd=TRUE) 
barplot(rbind(top_dam_data$FATCNT, top_dam_data$INJCNT), beside=TRUE, names.arg=top_dam_data$EVTYPE,
main="Fatality and Injury Counts for Top 20 Event Types", col=cbind("red", "blue"), ylab="Counts", ylim=c(1,1000000), log='y', las=2)
legend("topright", legend=c("Fatality", "Injury"), inset=c(-0.15, 0), fill=cbind("red", "blue"))

```

From the above figure, we can see that tornado, excessive heat, and flash flood are the three top disaster types that cause the most harm to population health (fatality and injury). 


### Events Most Damaging to Economy
For the second analysis, we examine the damage to property and crops caused by each disaster event. We first transform all dollar values of the property damage and crop damage to the same unit. We then conduct a similar analysis to the first part where we find the total amount of damage caused by each disaster type. The final ranked results of total property and crop damage will be shown in a table and a figure. 

```{r}
# extract propery damage values and crop damage values 
prop_data <- cbind.data.frame("EVTYPE"=data$EVTYPE, "PROPDMG"=data$PROPDMG)
crop_data <- cbind.data.frame("EVTYPE"=data$EVTYPE, "CROPDMG"=data$CROPDMG)

# number of rows in data 
nrows <- dim(data)[1]

# a function to convert damage value into real dollar value by multiplying the dimension scale
find_scale_factors <- function(original_data, nrows) {
  # initialize to all zeros in a vector 
  scale_factors <- matrix(0, nrow=length(original_data))

  # for each property or crop damage value, convert it into its real number value 
  # based on: 
  # https://rstudio-pubs-static.s3.amazonaws.com/58957_37b6723ee52b455990e149edde45e5b6.html
  #     only factors h, H, k, K, m, M, b, and B are considered. 
  #     Other factors are ignored and those rows are treated as zero and will be ranked
  #     at the bottom in sorting. 
  for (irow in 1:nrows) {
    if (original_data[irow] == "H" || original_data[irow] == "h") {
      scale_factors <- 1E+2
    } else if (original_data[irow] == "K" || original_data[irow] == "k") {
      scale_factors <- 1E+3
    } else if (original_data[irow] == "M" || original_data[irow] == "m") {
      scale_factors <- 1E+6
    } else if (original_data[irow] == "B" || original_data[irow] == "b") {
      scale_factors <- 1E+9
    } 
  }
  return(scale_factors)
}

# property and crop damage scale factors 
prop_dimen_scale <- find_scale_factors(data$PROPDMGEXP, nrows)
crop_dimen_scale <- find_scale_factors(data$CROPDMGEXP, nrows)

# update the property and crop damage data frame by the dimension scaling factor 
prop_data$PROPDMG <- prop_data$PROPDMG * prop_dimen_scale 
crop_data$CROPDMG <- crop_data$CROPDMG * crop_dimen_scale 

# form a new data frame using the unique event types 
prop_count <- matrix(0, nrow=length(ev_types))
crop_count <- matrix(0, nrow=length(ev_types))

# for each event type, sum up the property damage dollar amount across multiple events 
for (index in 1:length(ev_types)) {
  evtype <- ev_types[index]
  prop_count[index] <-  sum(prop_data$PROPDMG[prop_data$EVTYPE==evtype])  
  crop_count[index] <-  sum(crop_data$CROPDMG[crop_data$EVTYPE==evtype])  
}

# form a data frame to contain the event type and damage dollar totals 
prop_dam_data <- cbind.data.frame("EVTYPE"=ev_types, "PROPDMG"=prop_count)
crop_dam_data <- cbind.data.frame("EVTYPE"=ev_types, "CROPDMG"=crop_count)
# total damage from property and crop 
eco_data <- cbind.data.frame("EVTYPE"=ev_types, "DMG"=crop_count+prop_count)

# sort prop_dam_data and crop_dam_data in descending order according to damage dollar amounts 
prop_dam_sorted <- prop_dam_data[order(-prop_dam_data$PROPDMG), ]
crop_dam_sorted <- crop_dam_data[order(-crop_dam_data$CROPDMG), ]
# total damage sorted 
eco_data_sorted <- eco_data[order(-eco_data$DMG), ]

# print out the first 20 event types with the most damage to property  
head(prop_dam_sorted, n=20)

# use the top 20 data for plotting 
top_prop_dam_data <- prop_dam_sorted[1:20, ]

# plot the sorted damage amounts using a barplot for the top 20 diaster types
par(mfrow=c(3,1)) 
par(pin=c(4, 8), mai=c(3,1,0.5,1), mgp=c(3,0.5,0), xpd=TRUE) 
barplot(top_prop_dam_data$PROPDMG, names.arg=top_prop_dam_data$EVTYPE,
main="Property Damage in Dollars for Top 20 Event Types", col="purple", ylab="Dollars", ylim=c(1,1E+12), log='y', las=2)

# 
# print out the first 20 event types with the most damage to crop   
head(crop_dam_sorted, n=20)

# use the top 20 data for plotting 
top_crop_dam_data <- crop_dam_sorted[1:20, ]

# plot the sorted damage amounts using a barplot for the top 20 diaster types
par(pin=c(4, 8), mai=c(3,1,0.5,1), mgp=c(3,0.5,0), xpd=TRUE) 
barplot(top_crop_dam_data$CROPDMG, names.arg=top_crop_dam_data$EVTYPE,
main="Crop Damage in Dollars for Top 20 Event Types", col="orange", ylab="Dollars", ylim=c(1,1E+12), log='y', las=2)


# print out the top 20 events with total damage (property + crop)
head(eco_data_sorted, n=20)

# use the top 20 data for plotting
top_eco_data <- eco_data_sorted[1:20, ]
par(pin=c(4, 8), mai=c(3,1,0.5,1), mgp=c(3,0.5,0), xpd=TRUE) 
barplot(top_eco_data$DMG, names.arg=top_eco_data$EVTYPE,
main="Total Damage (Property and Crop) in Dollars for Top 20 Event Types", col="black", ylab="Dollars", ylim=c(1,1E+12), log='y', las=2)


```

From the above figure, we can see that flood, hurricane/typhoon, and tornado are the three diaster types that cause the most property damage. 


## Conclusion 

We analyzed the National Climatic Data Center Storm Events data from 1950 to 2011. We found from our analyses that tornado, heat, and flood are the top three disaster types incurring the most damage to people, based on the fatality and injury data. In comparison, flood, hurricane/typoon, and tornado are the top three disaster types causing the most property damage. Accurate forecast and emergency preparedness for these several types of disasters, therefore, are of paramount importance in saving people's lives and minimizing property damage. 

